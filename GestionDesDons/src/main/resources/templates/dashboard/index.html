<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link th:href="@{/css/styles.css}" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    .card { border-radius: .75rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
    /* Animations de base */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeInUp .6s ease both; }
    .stagger-1 { animation-delay: .05s; }
    .stagger-2 { animation-delay: .1s; }
    .stagger-3 { animation-delay: .15s; }
    .stagger-4 { animation-delay: .2s; }
    .card-hover { transition: transform .2s ease, box-shadow .2s ease; }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 .75rem 1.5rem rgba(0,0,0,.08); }
  </style>
  </head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" th:href="@{/dashboard}">Gestion des Dons</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" th:href="@{/donateurs}">Donateurs</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/campagnes}">Campagnes</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/dons}">Dons</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container py-4">
  <section>
    <div class="row g-3 mb-4 fade-in">
      <div class="col-md-4">
        <div class="card shadow-sm card-hover">
          <div class="card-body">
            <h6 class="text-muted">Total des dons</h6>
            <h3 id="totalDons" class="mb-0" th:text="${totalDons}">0</h3>
          </div>
        </div>
      </div>
    </div>

    <div class="grid fade-in">
      <div class="card shadow-sm card-hover stagger-1">
        <div class="card-body">
          <h5 class="card-title">Dons par campagne</h5>
          <canvas id="chartCampagnes" height="80"></canvas>
        </div>
      </div>
      <div class="card shadow-sm card-hover stagger-2">
        <div class="card-body">
          <h5 class="card-title">Dons par mois</h5>
          <canvas id="chartMois" height="80"></canvas>
        </div>
      </div>
      <div class="card shadow-sm card-hover stagger-3">
        <div class="card-body">
          <h5 class="card-title">Dons par moyen</h5>
          <canvas id="chartMoyen" height="80"></canvas>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
(async function(){
  try {
    const [parCampagne, parMois, parMoyen] = await Promise.all([
      fetch('/api/stats/par-campagne').then(r=>r.json()),
      fetch('/api/stats/par-mois').then(r=>r.json()),
      fetch('/api/stats/par-moyen').then(r=>r.json())
    ]);

    // Count-up animÃ© du total
    const totalEl = document.getElementById('totalDons');
    const target = Number((totalEl?.textContent || '0').toString().replace(/[^0-9.-]/g,'')) || 0;
    let current = 0;
    const steps = 30; // ~500-700ms
    const inc = target / steps;
    const ticker = () => {
      current += inc;
      if (current >= target) { totalEl.textContent = target.toLocaleString(); return; }
      totalEl.textContent = Math.round(current).toLocaleString();
      requestAnimationFrame(ticker);
    };
    requestAnimationFrame(ticker);

    const cc = document.getElementById('chartCampagnes');
    new Chart(cc, {
      type: 'bar',
      data: { labels: parCampagne.labels || [], datasets: [{ label: 'Montant', data: parCampagne.data || [], backgroundColor: 'rgba(13,110,253,0.5)', borderColor: 'rgba(13,110,253,1)' }] },
      options: {
        scales: { y: { beginAtZero: true } },
        animation: {
          duration: 900,
          easing: 'easeOutCubic',
          delay: (ctx) => ctx.dataIndex * 40
        }
      }
    });

    const cm = document.getElementById('chartMois');
    new Chart(cm, {
      type: 'line',
      data: { labels: parMois.labels || [], datasets: [{ label: 'Montant', data: parMois.data || [], borderColor: 'rgba(25,135,84,1)', backgroundColor: 'rgba(25,135,84,0.2)', tension: .3, fill: true }] },
      options: {
        scales: { y: { beginAtZero: true } },
        animation: { duration: 900, easing: 'easeOutCubic' }
      }
    });

    const cmy = document.getElementById('chartMoyen');
    new Chart(cmy, {
      type: 'pie',
      data: { labels: parMoyen.labels || [], datasets: [{ data: parMoyen.data || [], backgroundColor: ['#0d6efd','#6610f2','#6f42c1','#198754','#dc3545','#fd7e14'] }] },
      options: { animation: { duration: 900, easing: 'easeOutCubic' } }
    });
  } catch(e) { console.error(e); }
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
